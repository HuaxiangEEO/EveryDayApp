# 中国象棋复盘功能设计文档

## 一、功能概述

### 1.1 功能目标
增加完整的复盘功能，允许用户：
- 保存完整的对局记录（每一步走棋）
- 加载棋局时直接显示最终状态
- 回放整个对局过程（前进、后退、跳转到指定步数）
- 查看每一步的详细信息

### 1.2 核心功能
1. **走棋记录**：记录每一步的走棋信息
2. **棋局保存**：保存完整的对局历史
3. **棋局加载**：加载时显示最终状态
4. **复盘回放**：支持前进、后退、跳转等操作
5. **复盘控制**：播放、暂停、速度调节

## 二、数据结构设计

### 2.1 走棋记录（MoveRecord）

```typescript
interface MoveRecord {
  step: number;              // 步数（从1开始）
  from: Position;            // 起始位置
  to: Position;              // 目标位置
  piece: Piece;              // 移动的棋子
  capturedPiece: Piece | null;  // 被吃的棋子（如果有）
  player: 'red' | 'black';  // 走棋方
  timestamp: number;        // 走棋时间戳（可选）
  notation?: string;         // 中文记谱法（可选，如"炮二平五"）
}
```

### 2.2 棋局记录（GameRecord）

```typescript
interface GameRecord {
  id: string;                    // 唯一标识（UUID或时间戳）
  moves: MoveRecord[];           // 所有走棋记录
  initialBoard: BoardState;      // 初始棋盘状态（可选，用于快速初始化）
  finalBoard: BoardState;        // 最终棋盘状态
  currentPlayer: 'red' | 'black'; // 当前玩家（最终状态）
  gameOver: boolean;             // 是否结束
  winner: 'red' | 'black' | null; // 获胜方
  startTime: number;              // 开始时间
  endTime: number;                // 结束时间
  totalMoves: number;             // 总步数
  saveTime: number;               // 保存时间
}
```

### 2.3 复盘状态（ReplayState）

```typescript
interface ReplayState {
  isReplaying: boolean;          // 是否处于复盘模式
  currentStep: number;           // 当前显示的步数（0表示初始状态）
  isPlaying: boolean;            // 是否正在自动播放
  playSpeed: number;             // 播放速度（毫秒/步）
  totalSteps: number;            // 总步数
}
```

## 三、功能详细设计

### 3.1 走棋记录功能

#### 3.1.1 记录时机
- 每次走棋后立即记录
- 记录内容包括：起始位置、目标位置、移动的棋子、被吃的棋子（如果有）

#### 3.1.2 记录存储
- 存储在游戏状态中，作为 `GameState` 的一部分
- 使用数组存储，按顺序记录每一步

#### 3.1.3 数据结构扩展

```typescript
interface GameState {
  board: BoardState;
  currentPlayer: PieceColor;
  selectedPosition: Position | null;
  gameOver: boolean;
  winner: PieceColor | null;
  moves: MoveRecord[];        // 新增：走棋记录
  currentStep: number;        // 新增：当前步数（用于复盘）
}
```

### 3.2 棋局保存功能

#### 3.2.1 保存内容
- 完整的走棋记录数组
- 最终棋盘状态
- 游戏结果信息
- 时间信息（开始时间、结束时间、保存时间）

#### 3.2.2 保存格式
使用 JSON 格式存储在 localStorage：
```json
{
  "id": "20260202-123456",
  "moves": [
    {
      "step": 1,
      "from": {"row": 9, "col": 0},
      "to": {"row": 7, "col": 0},
      "piece": {"type": "rook", "color": "red", "id": "red-rook-1"},
      "capturedPiece": null,
      "player": "red",
      "timestamp": 1706856000000
    }
  ],
  "finalBoard": {...},
  "currentPlayer": "black",
  "gameOver": true,
  "winner": "red",
  "startTime": 1706856000000,
  "endTime": 1706856100000,
  "totalMoves": 45,
  "saveTime": 1706856100000
}
```

#### 3.2.3 保存时机
- 每次走棋后自动保存（更新完整记录）
- 游戏结束后自动保存
- 手动点击保存按钮

### 3.3 棋局加载功能

#### 3.3.1 加载行为
- 加载时直接显示最终棋盘状态
- 不自动播放复盘
- 显示"复盘"按钮，点击后进入复盘模式

#### 3.3.2 加载流程
1. 从 localStorage 读取保存的棋局
2. 解析 JSON 数据
3. 恢复最终棋盘状态
4. 恢复游戏状态（gameOver、winner等）
5. 恢复走棋记录数组
6. 显示最终状态，提供复盘入口

### 3.4 复盘回放功能

#### 3.4.1 复盘模式
- **普通模式**：正常游戏模式，可以走棋
- **复盘模式**：只读模式，只能查看历史走棋，不能走新棋

#### 3.4.2 复盘控制功能

**基础控制**：
- **上一步**：回到上一步
- **下一步**：前进到下一步
- **第一步**：跳转到初始状态
- **最后一步**：跳转到最终状态
- **跳转到指定步数**：输入步数跳转

**自动播放**：
- **播放/暂停**：自动播放复盘
- **播放速度**：1x、2x、4x（可调节）
- **播放方向**：正向播放、反向播放

#### 3.4.3 复盘显示

**棋盘显示**：
- 显示当前步数对应的棋盘状态
- 高亮显示当前步的走棋（起始位置和目标位置）
- 显示当前走棋方

**信息显示**：
- 当前步数 / 总步数（如：第 15 步 / 共 45 步）
- 当前走棋方
- 走棋信息（如："红方：车一进二"）
- 时间信息（可选）

**走棋列表**：
- 显示所有走棋记录的列表
- 当前步数高亮显示
- 点击列表项可跳转到对应步数

### 3.5 UI/UX 设计

#### 3.5.1 复盘控制面板

```
┌─────────────────────────────────────┐
│  复盘控制                            │
├─────────────────────────────────────┤
│  [◀◀] [◀] [▶] [▶▶]  [⏸] [1x ▼]    │
│  第一步 上一步 下一步 最后步 播放/暂停│
├─────────────────────────────────────┤
│  第 [15] / 45 步                    │
│  红方：车一进二                      │
└─────────────────────────────────────┘
```

#### 3.5.2 走棋列表面板（可选，侧边栏）

```
┌─────────────────────┐
│ 走棋记录            │
├─────────────────────┤
│ 1. 红方：车一进二   │
│ 2. 黑方：马8进7     │
│ 3. 红方：炮二平五   │
│ ...                 │
│ 15. 红方：车一进二 ←│
│ ...                 │
└─────────────────────┘
```

#### 3.5.3 状态切换

**普通模式 → 复盘模式**：
- 点击"复盘"按钮
- 显示复盘控制面板
- 禁用棋盘交互（不能走新棋）
- 显示当前步数对应的棋盘状态

**复盘模式 → 普通模式**：
- 点击"退出复盘"按钮
- 隐藏复盘控制面板
- 恢复棋盘交互
- 显示最终棋盘状态

## 四、技术实现方案

### 4.1 文件结构

```
src/
├── types/
│   └── chess.ts              # 扩展类型定义（MoveRecord, GameRecord）
├── utils/
│   ├── gameStorage.ts        # 棋局保存/加载（更新）
│   ├── replay.ts             # 复盘逻辑（新建）
│   └── notation.ts           # 中文记谱法（新建，可选）
├── hooks/
│   ├── useGameState.ts       # 游戏状态管理（更新）
│   └── useReplay.ts          # 复盘状态管理（新建）
├── components/
│   ├── ReplayControls.tsx    # 复盘控制面板（新建）
│   ├── MoveList.tsx          # 走棋列表（新建，可选）
│   └── ...
└── App.tsx                   # 主组件（更新）
```

### 4.2 核心功能实现

#### 4.2.1 走棋记录

**在 `useGameState` 中**：
- 扩展 `GameState` 接口，添加 `moves` 和 `currentStep`
- 在 `makeMove` 函数中，每次走棋后记录到 `moves` 数组
- 记录被吃的棋子信息

#### 4.2.2 复盘逻辑

**在 `useReplay` Hook 中**：
- 管理复盘状态（当前步数、播放状态等）
- 根据当前步数计算对应的棋盘状态
- 实现前进、后退、跳转等功能
- 实现自动播放功能

**棋盘状态计算**：
- 方法1：从初始状态开始，逐步应用每一步走棋（适合小步数）
- 方法2：使用快照机制，每N步保存一个快照（适合大步数，性能优化）

#### 4.2.3 保存/加载

**保存**：
- 保存完整的 `moves` 数组
- 保存最终棋盘状态（用于快速加载）
- 保存游戏元数据

**加载**：
- 加载时直接使用最终棋盘状态
- 保存 `moves` 数组供复盘使用
- 设置 `currentStep` 为最后一步

### 4.3 性能优化

1. **快照机制**：每10步保存一个棋盘快照，减少计算
2. **虚拟化列表**：走棋列表使用虚拟滚动（如果列表很长）
3. **防抖处理**：自动播放时使用 requestAnimationFrame 优化

## 五、使用流程

### 5.1 游戏流程

1. 开始新游戏 → 初始化空记录数组
2. 玩家走棋 → 记录到数组
3. AI走棋 → 记录到数组
4. 重复步骤2-3
5. 游戏结束 → 自动保存完整记录

### 5.2 复盘流程

1. 加载保存的棋局 → 显示最终状态
2. 点击"复盘"按钮 → 进入复盘模式
3. 使用控制按钮 → 查看每一步
4. 点击"退出复盘" → 返回最终状态

### 5.3 自动播放流程

1. 进入复盘模式
2. 点击"播放"按钮
3. 自动按顺序显示每一步
4. 可以暂停、调节速度
5. 播放到结束或手动停止

## 六、UI 组件设计

### 6.1 复盘控制面板组件

**位置**：游戏信息区域下方

**功能按钮**：
- ◀◀ 第一步
- ◀ 上一步
- ▶ 下一步
- ▶▶ 最后一步
- ⏸ 播放/暂停
- 速度选择下拉框（1x、2x、4x）

**信息显示**：
- 当前步数 / 总步数
- 当前走棋信息
- 进度条（可选）

### 6.2 走棋列表组件（可选）

**位置**：侧边栏或可折叠面板

**功能**：
- 显示所有走棋记录
- 当前步数高亮
- 点击跳转到对应步数
- 显示走棋的详细信息

### 6.3 状态指示

**普通模式**：
- 显示"保存棋局"、"重新开始"按钮
- 显示"复盘"按钮（如果有保存的记录）

**复盘模式**：
- 显示"退出复盘"按钮
- 显示复盘控制面板
- 棋盘只读，不能走新棋

## 七、边界情况处理

### 7.1 空记录
- 新游戏时，`moves` 数组为空
- 复盘按钮禁用或隐藏

### 7.2 单步记录
- 只有一步时，禁用"上一步"按钮
- 只有一步时，禁用"下一步"按钮

### 7.3 加载失败
- 如果加载的数据格式不正确，显示错误提示
- 提供"重新开始"选项

### 7.4 存储空间
- localStorage 有大小限制（通常5-10MB）
- 如果记录太大，提示用户或使用压缩

## 八、扩展功能（可选）

### 8.1 中文记谱法
- 实现标准的中文象棋记谱法
- 显示如"炮二平五"、"车一进二"等

### 8.2 多局记录
- 支持保存多个对局
- 对局列表界面
- 选择对局进行复盘

### 8.3 导出/导入
- 导出为 JSON 文件
- 导入 JSON 文件进行复盘
- 分享功能

### 8.4 分析功能
- 显示最佳走法建议
- 显示走棋评分
- 显示关键走棋点

## 九、实现优先级

### Phase 1（核心功能）✅ 已完成
1. ✅ 走棋记录数据结构
2. ✅ 保存/加载走棋记录
3. ✅ 复盘基础控制（上一步、下一步）
4. ✅ 复盘模式切换
5. ✅ 多棋局保存和管理
6. ✅ 初始状态查看已保存棋局
7. ✅ 加载后复盘或继续对弈
8. ✅ 最近一步走棋高亮显示

### Phase 2（增强功能）🔄 计划中
5. 自动播放功能
6. 速度调节
7. 跳转到指定步数（已实现基础版本）
8. 走棋列表显示

### Phase 3（优化功能）📋 待实现
9. 中文记谱法
10. 快照优化（性能优化）
11. 导出/导入（JSON文件）
12. 多局记录分析

## 十、注意事项

1. **数据兼容性**：新版本需要兼容旧版本的保存格式
2. **性能考虑**：大量步数时的性能优化
3. **用户体验**：复盘控制要直观易用
4. **错误处理**：完善的错误处理和提示

---

## 确认事项

请确认以下设计是否符合要求：

1. ✅ 保存每一步走棋记录
2. ✅ 加载时显示最终状态
3. ✅ 支持复盘回放功能
4. ✅ 复盘控制面板设计
5. ✅ 数据结构设计
6. ✅ 实现优先级

如有需要修改的地方，请告知，确认后开始实现代码。
